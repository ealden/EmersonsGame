<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Emerson's Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,300,600">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/style.css">

    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <div id="app" class="container">
      <h1>Emerson's Game</h1>

      <table class="u-full-width">
        <thead>
          <tr>
            <th>&nbsp;</th>
            <th v-for="n in track">{{ n }}</th>
            <th>FINISH</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(racer, i) in racers">
            <td nowrap>
              <span v-if="testMode" v-bind:id="'test-racer-' + racer.id + '-position'">{{ racer.position }}</span>
              <span v-if="testMode" v-bind:id="'test-racer-' + racer.id + '-damage'">{{ racer.damage }}</span>
              <span>{{ racer.name }} ({{ racer.damage }} damage)</span>
            </td>
            <td v-for="n in finishLine">
              <template v-if="racer.position == n">
                <template v-if="racer.position == finishLine">üèÜ</template>
                <template v-else>üöò</template>
              </template>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="row" v-if="ready">
        <div class="two columns">&nbsp;</div>
        <div class="eight columns centered">
          <div>
            <button id="roll-normal-speed" @click="rollNormalSpeed" class="normal-speed">Normal Speed</button>
            <button id="roll-super-speed" @click="rollSuperSpeed" class="super-speed">SUPER SPEED</button>
          </div>
        </div>
        <div class="two columns">
          <button id="new-race" @click="newRace">New Race</button>
        </div>
      </div>

      <input v-if="testMode" id="test-roll" v-model="roll">
      <input v-if="testMode" id="test-processing" v-model="processing">
    </div>

    <script>
      var app = new Vue({
        el: '#app',
        data () {
          return {
            finishLine: 0,
            racers: [],
            testMode: false,
            currentRacerIndex: 0,
            roll: null,
            processing: false
          }
        },
        computed: {
          track: function () {
            return (this.finishLine - 1)
          },
          ready: function () {
            return (this.racers.length > 0)
          },
          currentRacer: function () {
            return this.racers[this.currentRacerIndex]
          }
        },
        methods: {
          fetchRace: function () {
            axios
              .get('/api/races')
              .then(response => {
                this.racers = response.data.racers
                this.finishLine = response.data.finishLine
                this.testMode = response.data.testMode
              })
          },
          rollNormalSpeed: function (event) {
            this.doRoll('NORMAL')
          },
          rollSuperSpeed: function (event) {
            this.doRoll('SUPER')
          },
          nextRacer: function (event) {
            this.currentRacerIndex = ((this.currentRacerIndex + 1) % this.racers.length)
            this.roll = null
          },
          doRoll: function (speedType) {
            this.processing = true

            axios
              .post('/api/races/roll', {
                'id': this.currentRacer.id,
                'speedType': speedType,
                'roll': this.roll
              })
              .then(response => {
                axios
                  .get('/api/races')
                  .then(response => {
                    this.racers = response.data.racers
                    this.finishLine = response.data.finishLine
                    this.testMode = response.data.testMode

                    this.nextRacer()

                    this.processing = false
                  })
              })
          },
          newRace: function () {
            this.processing = true

            axios
              .post('/api/races/new', {})
              .then(response => {
                this.resetRace()

                this.processing = false
              })
          },
          resetRace: function () {
            this.fetchRace()
            this.currentRacerIndex = 0
          }
        },
        mounted () {
          this.resetRace()
        }
      })
    </script>
  </body>
</html>
